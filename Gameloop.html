<!DOCTYPE html>
<html lang="en">
	<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script language="javascript" src="jquery.hotkeys.js" type="text/javascript"></script>
	<script language="javascript" src="key_status.js" = type="text/javascript"></script>
	
	<script type="text/javascript">
		
		// SOURCES CITED:
		// code for fixed time step variable render from: http://www.isaacsukin.com/news/2015/01/detailed-explanation-javascript-game-loops-and-timing


		// get user input from slider to designate max FPS
		var maxFPS = 60;
		function updateFrameRate(newFrameRate) {
			maxFPS = newFrameRate;
			document.getElementById("FrameRateLabel").innerHTML=maxFPS;
		}
		$(window).bind("load", function() {
			
			// variables representing the canvas and the canvas' context (the context is used for actually drawing on the canvas)
			var canvas = document.getElementById("canvas");
			var context = canvas.getContext("2d");
			
			// the ball that we will be drawing on the canvas
			var ball = {x:canvas.width/2, //the x location of the ball
						y:canvas.height/2, //the y location of the ball
						radius:10, //the radius of the ball
						fillColor:"red", //what color should the ball be
						strokeColor:"grey", //what color should the outline of the ball be
						velocity_x:0, //how fast the ball will move in the x direction
						velocity_y:0}; //how fast the ball will move in the y direction

			// calc FPS to display on screen
			var fps = 0,
				framesThisSecond = 0,
				previousTimestep = 0;
			setInterval(function() {
				fps = framesThisSecond;
				framesThisSecond = 0;
			}, 1000);

			// variables for fixed update - variable render
			const timestep = 1000 / 60;	// 60 fps
			var delta = 0,
				numUpdates = 0,
				numDraws = 0,
				numCurrentUpdateSteps = 0,
				lastFpsUpdate = 0,
				framesDuringThisSecond = 0;

			// start us off the first time
			requestAnimationFrame(mainLoop);

			//Game Loop
			function mainLoop(timestamp) {

				// throttle gameloop to obey max FPS as designated by user
				if (timestamp - previousTimestep < (1000 / maxFPS)) {
					requestAnimationFrame(mainLoop);
					return;
				}

				// for fixed update - variable render
				delta += timestamp - previousTimestep;
				previousTimestep = timestamp;

				// spiral of death prevention
				if (timestamp > lastFpsUpdate + 1000) {
					fps = 0.25 * framesDuringThisSecond + 0.75 * fps;
					lastFpsUpdate = timestamp;
					framesDuringThisSecond = 0;
				}
				++framesDuringThisSecond;

				processInput();

				// update one fixed step at a time until gameloop is caught up
				numCurrentUpdateSteps = 0;
				while (delta >= timestep) {
					update(timestep);
					delta -= timestep;

					// break out of spiral of death
					if (++numCurrentUpdateSteps >= 200) {
						breakOutOfSpiral();
						break;
					}
				}

				draw();
				
				requestAnimationFrame(mainLoop);
			}
			
			// read the user's input from arrow keys
			function processInput() {
				if (keydown.left) {
					ball.velocity_x += -0.02;
				}
				if (keydown.right) {
					ball.velocity_x += 0.02;
				}
				if (keydown.up) {
					ball.velocity_y += -0.02;
				}
				if (keydown.down) {
					ball.velocity_y += 0.02;
				}
			}
			
			//Here is where we would update the state of our game or simulation (e.g., make the ball move). We will fill this in later.
			function update(delta) {
				console.log("Update")
				numUpdates++;
				ball.x += ball.velocity_x * delta;
				ball.y += ball.velocity_y * delta;
				
				// bounds checks
				if (ball.x < 0) {
					ball.x = 0;
					ball.velocity_x *= -1;
				}
				if (ball.x > canvas.width) {
					ball.x = canvas.width;
					ball.velocity_x *= -1;
				}
				if (ball.y < 0) {
					ball.y = 0;
					ball.velocity_y *= -1;
				}
				if (ball.y > canvas.height) {
					ball.y = canvas.height;
					ball.velocity_y *= -1;
				}
			}
			
			//Draw the scene. Here we simply erase what was previously drawn (e.g., where the ball used to be), then draw it again
			function draw() {
				console.log("Draw")
				numDraws++;
				//clear our drawing
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				//draw the ball
				context.beginPath();
				context.arc(ball.x, ball.y, ball.radius, 0, 2 * Math.PI, false);
				context.fillStyle = ball.fillColor;
				context.fill();
				context.lineWidth = 1;
				context.strokeStyle = ball.strokeColor;
				context.stroke();
				//context.closePath();
				context.fillText("FPS: " + fps, 10, 10);
				context.fillText("Updates: " + numUpdates, 10, 30);
				context.fillText("Draws: " + numDraws, 10, 50);
			}

			function breakOutOfSpiral() {
				delta = 0;
			}
		
		});
	</script>
	
	</head>
	
	<body>
		<canvas id="canvas" width="640" 
		height="480" style="border:1px solid #000;">
		Your browser does not support the canvas element.
		</canvas>
		<input type="range" min="1" max="60" value="60" onchange="updateFrameRate(this.value)"/>
		<span id="FrameRateLabel">60</span>
	</body>
	
</html>